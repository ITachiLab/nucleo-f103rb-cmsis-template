# Nucleo F103RB & CMSIS

This repository contains a template of CMSIS project for Nucleo F103RB development board. I created this repository because I wasn't able to find anything similar with only CMSIS and a minimum amount of code needed to get the board up and running.

I'm not a fan of HAL and bloated projects generated by CubeMX. Although this tool is very convenient for initial configuration, it lacks possibility of creating non-HAL projects with only CMSIS on board. I was quite startled by the amount of code CubeMX had generated for a simple project, and then I started wondering whether is it possible to make it smaller and simpler. Fortunately the answer was affirmative. 

## Content description

#### main

A directory containing only the main code. The main code sets up  a system clock and lights up the user LED (the green one). No more, no less. A clock initialization procedure is annotated with my comments, so you will see it's not as hard as you might thought it is.

#### platform

A directory with files specific for this board. All files in this directory were taken from CubeMX. I can't assure you I included everything, it works for me, but if you get errors saying that some header wasn't found, you'll have to do the following:

1. Download and install CubeMX.
2. In CubeMX, go to the package manager, it should be in **Help** menu.
3. Download a firmware package appropriate to your MCU.
4. Find out where downloaded packages are located (Help -> Updated settings).
5. Go to this directory, locate your freshly downloaded firmware and take any files you need and want. All headers, sources, libraries and linker files are there.

> **IMPORTANT**
>
> If you want to use a linker script from the firmware package, you have to modify it a little. For unknown to me reason, linker scripts contains a single `0` symbol in empty lines. You need to get rid of them before using the script.

#### CMakeLists.txt

A project configuration for CMake build system. Adapt it to your project.

#### arm.cmake

A toolchain configuration. You have to adapt this to your system and ARM compiler location.

## Building

As you can see I use CMake to generate all necessary build files. If you don't have it installed, never were a better time to do so. You also need to install the [ARM GCC toolchain](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads). I use version **6 2017 Q2 Update**, because newer versions produced weird compilation errors, and that's an issue experienced by a lot of programmers.

### Windows

To build this project on Windows I use MinGW, because Windows doesn't support `make` command natively (what a surprise). I didn't test configuring a CMake build system with a different generator, but you can try to. CMake for Windows has quite a lot of defined generators, so you can use *Visual Studio*, *Code Blocks*, *Eclipse* and more. Choose the best for you. If you decide to use MinGW, you have to install it.

Remember to edit the `arm.cmake` file and set a valid path pointing to a directory with the ARM toolchain. 

When everything is installed, create a `build` directory in root of this project, `cd` to it and run the below command:

`C:\Users\Foo\nucleo-f103rb-cmsis-template\build> cmake -G "MinGW Makefiles" ..`

If everything is properly configured, you shouldn't see any errors. If they are, then... Well... Annihilate them! Now when CMake did its job, it's time to build the binary:

`C:\Users\Foo\nucleo-f103rb-cmsis-template\build> mingw32-make make all`

> I have `mingw32-make.exe` in PATH so I can execute it from everywhere.

When everything went right, you should see your binary built in `build` directory. Its name will be the same as the project's name.

If you have OpenOCD installed and available in PATH, you can also run:

`C:\Users\Foo\nucleo-f103rb-cmsis-template\build> mingw32-make make program`

This will program your board through ST-Link. You can also use ST-Link utility to manually program the device.

### Linux

The process of creating a building environment for Linux is similar to Window (thanks to CMake). You also need CMake (which can be obtained by `apt-get`) and of course ARM toolchain. If you can't invoke `make` command that means you also need to install `build-essential` package.

Before building anything, edit `arm.cmake` file and  make sure that toolchain path matches the location of toolchain directory on your machine. If yes, create a `build` directory inside of this project, and from the inside of it execute the following command:

`cmake -G "Unix Makefiles" ..`

Sometimes it might happen that the first invocation of the above command will produced an error saying that GCC couldn't compile a simple test code. If you get something like that, try again and it should work. I don't know why, but the first execution fails, and consecutive works properly.

If CMake generated all necessary files, simply run `make all` and it should compile final binary. If you have OpenOCD in PATH, you can also use `make program` command to program your device.